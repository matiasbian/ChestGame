<!doctype html> 
<html lang="en"> 
<head> 
    <meta charset="UTF-8" />
    <title>Making your first Phaser 3 Game - Part 1</title>
    <script src="//cdn.jsdelivr.net/npm/phaser@3.11.0/dist/phaser.js"></script>
    <style type="text/css">
        body {
            margin: 0;
        }
    </style>
</head>
<body>

<script type="text/javascript">

    var config = {
        type: Phaser.AUTO,
        width: 1024,
        height: 768,
        physics: {
            default: 'arcade',
            arcade:{
                gravity: {y: 300},
                debug:false
            }
        },
        
        scene: {
            preload: preload,
            create: create,
            update: update
        }
    };

    var game = new Phaser.Game(config);
    var score = 0;
    var scoreText;
    var gameReference;
    class Items{
        constructor(go,polygon,xIni,yIni,xOffset,yOffset,alturaBase,scaleCollider,colliderResbaloso ){
            this.polygon = polygon;
            this.xIni = xIni;
            this.yIni = yIni;
            this.go = go;
            this.myCollider = null;
            this.their = null;
            this.theirColliderX = null;
            this.theirColliderY = null;
            this.altura = 0
            this.alturaBase = alturaBase;
            this.xOffset = xOffset;
            this.yOffset = yOffset;
            this.scaleCollider = scaleCollider;
            this.colliderResbaloso = colliderResbaloso;
            this.estoyEnConfre = false;
        }

        setMyAbove(their){
            this.theirColliderX = their.zone.x;
            this.theirColliderY = their.zone.y;
            this.their = their;
            this.altura =  searchMyClassByZone(this.their.zone).altura +1 + this.alturaBase ;
            searchMyClassByZone(this.their.zone).go.input.enabled=false;
            console.log("ALTURA NUEVA " + this.altura );

        }

        restoreMyAbove(){
            console.log("HABILITE AL DE ABAJO");
            this.their.zone.x = this.theirColliderX;
            this.their.zone.y = this.theirColliderY;
            var zoneTemp = searchMyClassByZone(this.their.zone);
            if (zoneTemp != null) {
                zoneTemp.go.input.enabled = true;
            }
            this.altura =0;
        }
    }

    class DropZone{
        constructor(zone,name,altura = 0){
            this.zone = zone;
            this.name = name;
            this.altura = altura;
        }
    }
    
    var itemsList=[];
    var zoneList=[];
    
    function preload ()
    {
         this.load.image('book1', 'images/objects/book1.png');
         this.load.image('chest', 'images/chest.png');
         this.load.image("book2", 'images/objects/book2.png');
         this.load.image("book3", 'images/objects/book3.png');
         this.load.image('box', 'images/objects/bx.png');
         this.load.image('smallbox', 'images/objects/smbx.png');
         this.load.image('transpa', 'images/objects/transpa.png');
         this.load.image('globe', 'images/objects/globe.png');
         this.load.image('flower', 'images/objects/flower.png');
         this.load.image('pyramid', 'images/objects/pyramid.png');
         this.load.image('cyl', 'images/objects/cyl.png');
        this.load.image('rec-cb', 'images/objects/rec-cb.png');
         this.load.image('background', 'images/background.jpg');
    }
    
    function create ()
    {

        gameReference = this;
        var background = this.add.image(400, 250, 'background').setScale(1.3);
        //items creation
           // var x = 50;
            //var y = 50;
            //var image = this.add.image(x, y, 'ayu').setInteractive();
            //this.input.setDraggable(image);
            //var book1 = new Items(image,null,x,y);
            //itemsList.push(book1);
        itemCreation(150,650,'book1',this,0,-10,0.6,0,0.5);
        itemCreation(850,150,'book2',this,0,-10,0.6,0,0.5);
        itemCreation(760,590,'book3',this,0,-10,0.6,0,0.5);
        itemCreation(920,620,'flower',this,0,-20,0.6,0,0.3,true);
        itemCreation(880,510,'pyramid',this,0,-20,0.6,0,0.3,true);
        itemCreation(280,690,'globe',this,0,-20,0.6,0,0.3,true);
        itemCreation(100,550,'smallbox',this,0,-20,0.6,0,0.4);
        itemCreation(150,480,'cyl',this,0,-20,0.6,0,0.4,true);
        itemCreation(900,260,'box',this,0,-50,0.6,3,0.9);
        itemCreation(700,150,'rec-cb',this,0,-10,0.6,0,0.7);
        //


            
            
        
        
        
        
        
        
         //  A drop zone
  
        
        
        var offset = 480;
        var offsety = 280;

        var polygon = new Phaser.Geom.Polygon([
        offset+120, offsety -15,
        offset+270, offsety +105,
        offset+0, offsety +215,
        offset-140, offsety +135,
    ]);
    zoneCreation('chest',500,300,polygon,this,0.8);
    //var zone = this.add.image(500, 300, 'chest').setInteractive(polygon,function(hitArea, x, y, gameObject){
     //      return choCo(hitArea, x,y,gameObject);
    //});

    //zone.setScale(0.8);
    //zone.input.dropZone = true;
        
    var graphics = this.add.graphics({ x: 0, y: 0 });

    graphics.lineStyle(2, 0x00aa00);

    graphics.beginPath();

    graphics.moveTo(polygon.points[0].x, polygon.points[0].y);

    for (var i = 1; i < polygon.points.length; i++)
    {
        graphics.lineTo(polygon.points[i].x, polygon.points[i].y);
    }

    graphics.closePath();
    graphics.strokePath();
        
    graphics.lineStyle(2, 0x115f55);
    
    
        
        
        
        
        
    this.input.on('dragstart', function (pointer, gameObject) {

        this.children.bringToTop(gameObject);
        var it = searchMyClass(gameObject);
        if (it.myCollider != null){
            it.myCollider.destroy();
            
        }
        gameObject.x = pointer.x - gameObject.displayWidth/4;
        gameObject.y = pointer.y + gameObject.displayHeight/4;
    }, this);

    this.input.on('drag', function (pointer, gameObject, dragX, dragY) {

        gameObject.x = pointer.x - gameObject.displayWidth/4;
        gameObject.y = pointer.y + gameObject.displayHeight/4;

    });

    this.input.on('dragenter', function (pointer, gameObject, dropZone) {
        
        if(searchMyClassZone(dropZone).name == "chest"){
            dropZone.setTint(0x00ff00);
        }else{
            gameObject.setTint(0x00AAAA);
        }

    });

    this.input.on('dragleave', function (pointer, gameObject, dropZone) {

        dropZone.clearTint();
        gameObject.clearTint();

    });

    this.input.on('drop', function (pointer, gameObject, dropZone) {
        var choqueCofre = searchMyClassZone(dropZone).name == "chest"  ;
        if (!choqueCofre) {
            gameObject.x = dropZone.x+ searchMyClass(gameObject).xOffset;
            gameObject.y = dropZone.y+ searchMyClass(gameObject).yOffset;
            if (searchMyClassByZone(dropZone).colliderResbaloso ){
                gameObject.x = searchMyClass(gameObject).xIni;
                gameObject.y = searchMyClass(gameObject).yIni;
                searchMyClass(gameObject).estoyEnConfre = false;
            }
        }else{
             if (!AboveOtherObject(gameObject) ){
                
            }
        }
        
       
        //console.log(gameReference);
        if (searchMyClass(gameObject).myCollider != null && !choqueCofre && !searchMyClassByZone(dropZone).colliderResbaloso){
            searchMyClass(gameObject).myCollider.destroy();
            
        }

        if ( searchMyClass(gameObject).their != null  && searchMyClass(gameObject).their != searchMyClassZone(dropZone) && !searchMyClassByZone(dropZone).colliderResbaloso){
            searchMyClass(gameObject).restoreMyAbove();
        }
        

        if (choqueCofre || (searchMyClassByZone(dropZone).alturaBase + searchMyClass(gameObject).alturaBase + searchMyClassByZone(dropZone).altura < 2 ) && !searchMyClassByZone(dropZone).colliderResbaloso) {

            var colo = searchMyClass(gameObject).myCollider = zoneCreation('transpa', gameObject.x + searchMyClass(gameObject).xOffset, gameObject.y + searchMyClass(gameObject).yOffset, newPolygon(gameObject), gameReference, 0.2* searchMyClass(gameObject).scaleCollider);
            searchMyClass(gameObject).estoyEnConfre = true;
            //console.log(Phaser.Geom.Rectangle.ContainsRect());
            //console.log(colo.input.hitArea);
             
        }
        if (!choqueCofre && !searchMyClassByZone(dropZone).colliderResbaloso){
            searchMyClass(gameObject).setMyAbove(searchMyClassZone(dropZone));

            searchMyClassZone(dropZone).zone.x = 9999;
            searchMyClassZone(dropZone).zone.y = 9999;




        }
        //gameObject.setScale(0.2);

        //gameObject.input.enabled = false;

        dropZone.clearTint();

    });

    this.input.on('dragend', function (pointer, gameObject, dropped) {

        if (!dropped)
        {
            var it = searchMyClass(gameObject);
            gameObject.x = it.xIni;
            gameObject.y = it.yIni;
            it.estoyEnConfre = false;
            if (it.their != null){
                it.restoreMyAbove();
            }
        }


    });
        


        
    }
    
    function choCo(poly,x,y,go){
        return Phaser.Geom.Polygon.Contains(poly,x,y);

    }
    
    function searchMyClass(itemm){
        for (i = 0 ; i < itemsList.length; i++){
            if (itemsList[i].go == itemm){
                return itemsList[i];
            }
        }
        return null;
    }

    function searchMyClassByZone(zone){
        for (i = 0 ; i < itemsList.length; i++){
            if (itemsList[i].myCollider == zone){
                return itemsList[i];
            }
        }
        return null;
    }

    function searchMyClassZone(zone){
        for (i = 0 ; i < zoneList.length; i++){
            if (zoneList[i].zone == zone){
                return zoneList[i];
            }
        }
        return null;
    }

    function update ()
    {
        

        
    }
    function newPolygon(objRef){
        var polygon = new Phaser.Geom.Polygon([
            objRef.x+120, objRef.y +20,
            objRef.x+260, objRef.y +80,
            objRef.x+50, objRef.y +210,
            objRef.x-50, objRef.y +110,
            ])

    }
    function itemCreation(x,y,name,proc,xOffset = 0,yOffset = - 20,scale = 1,alturaBase = 0,scaleCollider = 1, colliderResbaloso = false){

        var image = proc.add.image(x, y, name).setInteractive();
        image.setScale(scale)
        proc.input.setDraggable(image);
        itemsList.push(new Items(image,null,x,y,xOffset,yOffset,alturaBase,scaleCollider,colliderResbaloso));
    }

    function zoneCreation(name,x,y,polygoon,fnc, scale = 1){
        var zoned = fnc.add.image(x, y, name).setInteractive(polygoon,function(hitArea, x, y, gameObject){
            return choCo(hitArea, x,y,gameObject);
        });

        zoned.setScale(scale);
        zoned.input.dropZone = true;
        zoneList.push(new DropZone(zoned,name));
        return zoned;
    }
    
    function AboveOtherObject(gameObject){
        
        
        for (i = 0 ; i < itemsList.length; i++){
            if (itemsList[i].estoyEnConfre){
                
                //console.log(gameObject.input.hitArea);
               // console.log (gameObject)
               // console.log (rect);
               // console.log (rect2);
               // console.log(Phaser.Geom.Rectangle.Overlaps(rect,rect2) );
            }
        }
        return false;
    }
    
    

</script>

</body>
</html>



